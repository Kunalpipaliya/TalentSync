<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>Firebase Connection Test</h1>
        <p>This page helps test the Firebase connection and data loading for TalentSync.</p>
        
        <div>
            <button class="btn" onclick="testConnection()">Test Firebase Connection</button>
            <button class="btn" onclick="testDataLoading()">Test Data Loading</button>
            <button class="btn" onclick="createDemoData()">Create Demo Data</button>
            <button class="btn" onclick="testDashboardAccess()">Test Dashboard Access</button>
            <button class="btn" onclick="testPostJobAccess()">Test Post Job Access</button>
            <button class="btn" onclick="testCategoryFiltering()">Test Category Filtering</button>
            <button class="btn" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="log" class="log">Click a button above to start testing...\n</div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="script.js"></script>
    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testConnection() {
            log('Testing Firebase connection...', 'info');
            
            try {
                if (!window.firebaseService) {
                    log('ERROR: Firebase service not found', 'error');
                    return;
                }
                
                log('Firebase service found', 'success');
                log(`App: ${firebaseService.app ? 'OK' : 'MISSING'}`, firebaseService.app ? 'success' : 'error');
                log(`Auth: ${firebaseService.auth ? 'OK' : 'MISSING'}`, firebaseService.auth ? 'success' : 'error');
                log(`Firestore: ${firebaseService.db ? 'OK' : 'MISSING'}`, firebaseService.db ? 'success' : 'error');
                
                // Test Firestore connection
                await firebaseService.testFirestoreConnection();
                log('Firestore connection test completed', 'success');
                
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function testDataLoading() {
            log('Testing data loading...', 'info');
            
            try {
                if (!window.firebaseService) {
                    log('ERROR: Firebase service not found', 'error');
                    return;
                }
                
                // Test jobs loading
                log('Loading jobs...', 'info');
                const jobsResult = await firebaseService.loadJobs();
                log(`Jobs result: ${jobsResult.success ? 'SUCCESS' : 'FAILED'}`, jobsResult.success ? 'success' : 'error');
                if (jobsResult.success) {
                    log(`Jobs loaded: ${jobsResult.data.length}`, 'success');
                } else {
                    log(`Jobs error: ${jobsResult.error}`, 'error');
                }
                
                // Test freelancers loading
                log('Loading freelancers...', 'info');
                const freelancersResult = await firebaseService.loadFreelancers();
                log(`Freelancers result: ${freelancersResult.success ? 'SUCCESS' : 'FAILED'}`, freelancersResult.success ? 'success' : 'error');
                if (freelancersResult.success) {
                    log(`Freelancers loaded: ${freelancersResult.data.length}`, 'success');
                } else {
                    log(`Freelancers error: ${freelancersResult.error}`, 'error');
                }
                
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function createDemoData() {
            log('Creating demo data...', 'info');
            
            try {
                if (!window.firebaseService) {
                    log('ERROR: Firebase service not found', 'error');
                    return;
                }
                
                await firebaseService.initializeDemoData();
                log('Demo data creation completed', 'success');
                
                // Test loading after creation
                setTimeout(testDataLoading, 2000);
                
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function testCategoryFiltering() {
            log('Testing category filtering...', 'info');
            
            try {
                // Test category mapping
                const categories = [
                    'Web Development',
                    'Mobile Development', 
                    'Graphic Design',
                    'Content Writing',
                    'Digital Marketing',
                    'Video & Animation',
                    'Data Science'
                ];
                
                log('Testing category mappings:', 'info');
                categories.forEach(category => {
                    // Simulate the browseCategory function logic
                    const categoryMapping = {
                        'Web Development': 'web-development',
                        'Mobile Development': 'mobile-development', 
                        'Graphic Design': 'design',
                        'Content Writing': 'writing',
                        'Digital Marketing': 'marketing',
                        'Video & Animation': 'video-editing',
                        'Data Science': 'data-science',
                        'Voice & Audio': 'translation'
                    };
                    
                    const filterValue = categoryMapping[category] || category.toLowerCase().replace(/\s+/g, '-').replace(/&/g, '');
                    log(`${category} -> ${filterValue}`, 'success');
                });
                
                // Test setting and getting from sessionStorage
                log('Testing sessionStorage...', 'info');
                sessionStorage.setItem('selectedCategory', 'web-development');
                const stored = sessionStorage.getItem('selectedCategory');
                log(`Stored: web-development, Retrieved: ${stored}`, stored === 'web-development' ? 'success' : 'error');
                
                // Test the actual browseCategory function if available
                if (typeof talentSync !== 'undefined' && talentSync.browseCategory) {
                    log('Testing browseCategory function...', 'info');
                    // Don't actually redirect, just test the storage
                    const originalHref = window.location.href;
                    
                    // Override window.location.href temporarily
                    let redirectUrl = '';
                    Object.defineProperty(window.location, 'href', {
                        set: function(url) { redirectUrl = url; },
                        get: function() { return originalHref; }
                    });
                    
                    talentSync.browseCategory('Web Development');
                    const categoryStored = sessionStorage.getItem('selectedCategory');
                    log(`browseCategory test - stored: ${categoryStored}`, categoryStored === 'web-development' ? 'success' : 'error');
                    
                    // Restore original behavior
                    Object.defineProperty(window.location, 'href', {
                        value: originalHref,
                        writable: true
                    });
                }
                
                sessionStorage.removeItem('selectedCategory');
                log('Category filtering test completed', 'success');
                log('Try clicking on a category in the index page to test', 'info');
                
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function testPostJobAccess() {
            log('Testing post job access...', 'info');
            
            try {
                // Wait for talentSync to be available
                if (typeof talentSync === 'undefined') {
                    log('ERROR: talentSync not available', 'error');
                    return;
                }
                
                // Test current user
                log(`Current user: ${talentSync.currentUser ? 'FOUND' : 'NOT FOUND'}`, talentSync.currentUser ? 'success' : 'error');
                
                if (talentSync.currentUser) {
                    log(`User name: ${talentSync.currentUser.fullName}`, 'success');
                    log(`User role: ${talentSync.currentUser.role}`, 'success');
                    
                    // Check if user can post jobs
                    if (talentSync.currentUser.role === 'client') {
                        log('User is a CLIENT - can post jobs', 'success');
                        log('Post job page should be accessible', 'success');
                        log('You can try navigating to post-job.html', 'info');
                    } else if (talentSync.currentUser.role === 'freelancer') {
                        log('User is a FREELANCER - cannot post jobs', 'info');
                        log('Post job page will redirect to dashboard', 'info');
                    } else {
                        log(`Unknown user role: ${talentSync.currentUser.role}`, 'error');
                    }
                } else {
                    log('Post job page will redirect to login', 'error');
                    log('Please log in first', 'info');
                }
                
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function testDashboardAccess() {
            log('Testing dashboard access...', 'info');
            
            try {
                // Wait for talentSync to be available
                if (typeof talentSync === 'undefined') {
                    log('ERROR: talentSync not available', 'error');
                    return;
                }
                
                // Test current user
                log(`Current user: ${talentSync.currentUser ? 'FOUND' : 'NOT FOUND'}`, talentSync.currentUser ? 'success' : 'error');
                
                if (talentSync.currentUser) {
                    log(`User name: ${talentSync.currentUser.fullName}`, 'success');
                    log(`User role: ${talentSync.currentUser.role}`, 'success');
                    log(`User ID: ${talentSync.currentUser.id || talentSync.currentUser.uid}`, 'success');
                }
                
                // Test Firebase auth
                if (firebaseService && firebaseService.auth) {
                    const firebaseUser = firebaseService.auth.currentUser;
                    log(`Firebase user: ${firebaseUser ? 'FOUND' : 'NOT FOUND'}`, firebaseUser ? 'success' : 'info');
                    if (firebaseUser) {
                        log(`Firebase UID: ${firebaseUser.uid}`, 'success');
                    }
                }
                
                // Test storage
                const sessionUser = sessionStorage.getItem('currentUser');
                const localUser = localStorage.getItem('currentUser');
                log(`Session storage: ${sessionUser ? 'HAS USER' : 'EMPTY'}`, sessionUser ? 'success' : 'info');
                log(`Local storage: ${localUser ? 'HAS USER' : 'EMPTY'}`, localUser ? 'success' : 'info');
                
                // Test dashboard access
                if (talentSync.currentUser) {
                    log('Dashboard should be accessible', 'success');
                    log('You can try navigating to dashboard.html', 'info');
                } else {
                    log('Dashboard will redirect to login', 'error');
                    log('Please log in first', 'info');
                }
                
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        // Auto-test connection when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Page loaded, testing connection...', 'info');
                testConnection();
            }, 1000);
        });
    </script>
</body>
</html>