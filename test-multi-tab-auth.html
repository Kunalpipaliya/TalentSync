<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Tab Authentication Test - TalentSync</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }
        
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .status-display {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .current-user {
            background: var(--success-bg);
            color: var(--success-color);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        .no-user {
            background: var(--warning-bg);
            color: var(--warning-color);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        .instructions {
            background: var(--info-bg);
            color: var(--info-color);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-handshake"></i>
                <span>TalentSync</span>
            </div>
            
            <div class="nav-menu" id="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="browse-jobs.html" class="nav-link">Browse Jobs</a>
                <a href="freelancers.html" class="nav-link">Find Talent</a>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
            </div>
            
            <div class="nav-actions" id="nav-actions">
                <button class="theme-toggle" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
                <!-- User-specific content will be populated by JavaScript -->
            </div>
            
            <div class="nav-toggle" id="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <div class="test-container">
        <h1><i class="fas fa-tabs"></i> Multi-Tab Authentication Test</h1>
        
        <div class="instructions">
            <h4><i class="fas fa-info-circle"></i> How to Test Multi-Tab Authentication</h4>
            <ol>
                <li>Open this page in multiple browser tabs</li>
                <li>Login with different users in different tabs</li>
                <li>Each tab should maintain its own user session</li>
                <li>Use the buttons below to test various scenarios</li>
            </ol>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-user"></i> Current Tab Status</h3>
            <div id="current-status" class="status-display">Loading...</div>
            
            <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="refreshStatus()">
                    <i class="fas fa-refresh"></i> Refresh Status
                </button>
                <button class="btn btn-info btn-sm" onclick="showTabId()">
                    <i class="fas fa-id-card"></i> Show Tab ID
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-users"></i> All Active Users</h3>
            <div id="all-users-status" class="status-display">Loading...</div>
            
            <div class="btn-group">
                <button class="btn btn-info btn-sm" onclick="showAllActiveUsers()">
                    <i class="fas fa-list"></i> Show All Active Users
                </button>
                <button class="btn btn-warning btn-sm" onclick="logoutAllTabs()">
                    <i class="fas fa-sign-out-alt"></i> Logout All Tabs
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-sign-in-alt"></i> Quick Login (Demo Users)</h3>
            <p>Use these buttons to quickly login with demo users:</p>
            
            <div class="btn-group">
                <button class="btn btn-success btn-sm" onclick="quickLogin('client@demo.com', 'password123')">
                    <i class="fas fa-briefcase"></i> Login as Client
                </button>
                <button class="btn btn-success btn-sm" onclick="quickLogin('freelancer@demo.com', 'password123')">
                    <i class="fas fa-user-tie"></i> Login as Freelancer
                </button>
                <button class="btn btn-success btn-sm" onclick="quickLogin('mike@business.com', 'password123')">
                    <i class="fas fa-building"></i> Login as Mike (Client)
                </button>
                <button class="btn btn-success btn-sm" onclick="quickLogin('sarah@design.com', 'password123')">
                    <i class="fas fa-paint-brush"></i> Login as Sarah (Designer)
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-cogs"></i> Authentication Actions</h3>
            
            <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="talentSync.showLoginModal()">
                    <i class="fas fa-sign-in-alt"></i> Open Login Modal
                </button>
                <button class="btn btn-primary btn-sm" onclick="talentSync.showSignupModal()">
                    <i class="fas fa-user-plus"></i> Open Signup Modal
                </button>
                <button class="btn btn-danger btn-sm" onclick="talentSync.logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout This Tab
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-external-link-alt"></i> Navigation Tests</h3>
            <p>Test navigation with different user states:</p>
            
            <div class="btn-group">
                <button class="btn btn-outline btn-sm" onclick="window.open('dashboard.html', '_blank')">
                    <i class="fas fa-tachometer-alt"></i> Open Dashboard (New Tab)
                </button>
                <button class="btn btn-outline btn-sm" onclick="window.open('post-job.html', '_blank')">
                    <i class="fas fa-plus"></i> Open Post Job (New Tab)
                </button>
                <button class="btn btn-outline btn-sm" onclick="window.open('browse-jobs.html', '_blank')">
                    <i class="fas fa-search"></i> Open Browse Jobs (New Tab)
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-bug"></i> Debug Information</h3>
            <div id="debug-info" class="status-display">Click "Show Debug Info" to see technical details</div>
            
            <div class="btn-group">
                <button class="btn btn-secondary btn-sm" onclick="showDebugInfo()">
                    <i class="fas fa-bug"></i> Show Debug Info
                </button>
                <button class="btn btn-secondary btn-sm" onclick="clearAllStorage()">
                    <i class="fas fa-trash"></i> Clear All Storage
                </button>
            </div>
        </div>
    </div>

    <!-- Modals and Overlays -->
    <div id="modal-overlay" class="modal-overlay"></div>
    
    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="script.js"></script>

    <script>
        // Test page specific functions
        function refreshStatus() {
            updateCurrentStatus();
            updateAllUsersStatus();
        }

        function updateCurrentStatus() {
            const statusDiv = document.getElementById('current-status');
            const user = talentSync.currentUser;
            
            if (user) {
                statusDiv.innerHTML = `
<strong>✅ User Logged In</strong>
Tab ID: ${talentSync.tabId}
Name: ${user.fullName}
Email: ${user.email}
Role: ${user.role}
User ID: ${user.id || user.uid}
                `.trim();
                statusDiv.className = 'status-display current-user';
            } else {
                statusDiv.innerHTML = `
<strong>❌ No User Logged In</strong>
Tab ID: ${talentSync.tabId}
Status: Not authenticated
                `.trim();
                statusDiv.className = 'status-display no-user';
            }
        }

        function updateAllUsersStatus() {
            const statusDiv = document.getElementById('all-users-status');
            const activeUsers = talentSync.getActiveUsers();
            
            if (activeUsers.length === 0) {
                statusDiv.innerHTML = 'No users logged in across any tabs';
            } else {
                let html = `<strong>Active Users (${activeUsers.length}):</strong>\n\n`;
                activeUsers.forEach((user, index) => {
                    html += `${index + 1}. ${user.fullName} (${user.role}) - ID: ${user.id}\n`;
                });
                statusDiv.innerHTML = html;
            }
        }

        function showTabId() {
            alert(`Current Tab ID: ${talentSync.tabId}`);
        }

        function showAllActiveUsers() {
            const result = talentSync.showActiveUsers();
            updateAllUsersStatus();
        }

        function logoutAllTabs() {
            if (confirm('This will logout all users from all tabs. Continue?')) {
                talentSync.logoutAllTabs();
                setTimeout(refreshStatus, 500);
            }
        }

        async function quickLogin(email, password) {
            try {
                // Create a fake form event
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);
                formData.append('remember', 'false');

                const fakeEvent = {
                    preventDefault: () => {},
                    target: {
                        elements: {
                            email: { value: email },
                            password: { value: password },
                            remember: { checked: false }
                        }
                    }
                };

                // Add FormData to the fake event
                Object.defineProperty(fakeEvent.target, 'elements', {
                    value: {
                        email: { value: email },
                        password: { value: password },
                        remember: { checked: false }
                    }
                });

                // Mock FormData constructor
                const originalFormData = window.FormData;
                window.FormData = function(form) {
                    this.get = function(key) {
                        if (key === 'email') return email;
                        if (key === 'password') return password;
                        if (key === 'remember') return false;
                        return null;
                    };
                };

                await talentSync.handleLogin(fakeEvent);
                
                // Restore original FormData
                window.FormData = originalFormData;
                
                setTimeout(refreshStatus, 1000);
            } catch (error) {
                console.error('Quick login error:', error);
                talentSync.showToast('Quick login failed: ' + error.message, 'error');
            }
        }

        function showDebugInfo() {
            const debugDiv = document.getElementById('debug-info');
            const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '{}');
            const rememberedUser = localStorage.getItem('rememberedUser');
            const sessionUser = sessionStorage.getItem('currentUser');
            
            debugDiv.innerHTML = `
<strong>Storage Debug Information:</strong>

Tab ID: ${talentSync.tabId}
Firebase Available: ${typeof firebaseService !== 'undefined' && firebaseService ? 'Yes' : 'No'}
Firebase User: ${firebaseService?.auth?.currentUser?.email || 'None'}

Session Storage (This Tab):
${sessionUser ? JSON.stringify(JSON.parse(sessionUser), null, 2) : 'Empty'}

Local Storage - Active Users (All Tabs):
${JSON.stringify(activeUsers, null, 2)}

Local Storage - Remembered User:
${rememberedUser ? JSON.stringify(JSON.parse(rememberedUser), null, 2) : 'None'}

TalentSync Current User:
${talentSync.currentUser ? JSON.stringify(talentSync.currentUser, null, 2) : 'None'}
            `.trim();
        }

        function clearAllStorage() {
            if (confirm('This will clear ALL storage data. Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                talentSync.currentUser = null;
                talentSync.updateUI();
                talentSync.showToast('All storage cleared', 'success');
                setTimeout(refreshStatus, 500);
            }
        }

        // Auto-refresh status every 2 seconds
        setInterval(refreshStatus, 2000);

        // Initial status update
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(refreshStatus, 1000);
        });

        // Listen for user changes
        window.addEventListener('userLoaded', refreshStatus);
        window.addEventListener('storage', refreshStatus);
    </script>
</body>
</html>